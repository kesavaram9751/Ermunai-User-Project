<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout â€“ Ermunai Organic Farm Foods</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f9faf6;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        @media(max-width: 800px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .form-section,
        .summary-section {
            background: white;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .form-section h2,
        .summary-section h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #2f6f31;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
        }

        .summary-section .cart-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-section .cart-item span {
            font-size: 16px;
        }

        .summary-section .totals {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .totals .line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .totals .line.total {
            font-weight: bold;
            font-size: 18px;
        }

        .btn-pay {
            display: inline-block;
            padding: 12px 24px;
            background: #2f6f31;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-pay:hover {
            background: #244021;
        }
    </style>
</head>

<body>
    <h1>Checkout</h1>
    <div class="container">
        <!-- Left: Billing / Shipping Details Form -->
        <div class="form-section">
            <h2>Your Details</h2>
            <form id="checkoutForm">
                <div class="form-group">
                    <label for="name">Full Name*</label>
                    <input type="text" id="name" name="name" required />
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number*</label>
                    <input type="tel" id="phone" name="phone" required />
                </div>

                <div class="form-group">
                    <label for="address">Address*</label>
                    <textarea id="address" name="address" rows="3" required></textarea>
                </div>

                <div class="form-group">
                    <label for="pin">Pin Code*</label>
                    <input type="text" id="pin" name="pin" required />
                </div>

                <div class="form-group">
                    <label for="city">City*</label>
                    <input type="text" id="city" name="city" required />
                </div>

                <div class="form-group">
                    <label for="state">State / Province*</label>
                    <input type="text" id="state" name="state" required />
                </div>

                <!-- you can add more fields as needed -->
            </form>
        </div>

        <!-- Right: Order Summary and Payment -->
        <div class="summary-section">
            <h2>Order Summary</h2>
            <div id="itemsList">
                <!-- JS will populate cart items here -->
            </div>

            <div class="totals">
                <div class="line">
                    <span>Subtotal</span>
                    <span id="subtotalAmt">â‚¹0</span>
                </div>
                <div class="line">
                    <span>Shipping</span>
                    <span id="shippingAmt">â‚¹0</span>
                </div>
                <div class="line total">
                    <span>Total</span>
                    <span id="totalAmt">â‚¹0</span>
                </div>
            </div>

            <button id="btnPay" class="btn-pay">Pay Now</button>
        </div>
    </div>

   <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
Â  // -------------------------------------------------------------------------------------
Â  // ðŸ›‘ CRITICAL CHANGE: REPLACE THIS PLACEHOLDER WITH YOUR LIVE RAILWAY URL
Â  // Example: https://sparkling-commitment-eqqga-asia-southeast1.railway.app
Â  // -------------------------------------------------------------------------------------
Â  const API_BASE_URL = "ermunai-user-project-production.up.railway.app";

Â  // ---------- Load cart from localStorage ----------
Â  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
Â  const itemsDiv = document.getElementById("itemsList");
Â  const subtotalEl = document.getElementById("subtotalAmt");
Â  const shippingEl = document.getElementById("shippingAmt");
Â  const totalEl = document.getElementById("totalAmt");
Â  const btnPay = document.getElementById("btnPay");
Â  const pinInput = document.getElementById("pin");
Â  const form = document.getElementById("checkoutForm");

Â  function renderCart() {
Â  Â  itemsDiv.innerHTML = "";
Â  Â  let subtotal = 0;
Â  Â  cart.forEach(item => {
Â  Â  Â  const itemDiv = document.createElement("div");
Â  Â  Â  itemDiv.className = "cart-item";
Â  Â  Â  const nameSpan = document.createElement("span");
Â  Â  Â  nameSpan.textContent = item.name + " Ã— " + item.qty;
Â  Â  Â  const priceSpan = document.createElement("span");
Â  Â  Â  priceSpan.textContent = "â‚¹" + (item.price * item.qty).toFixed(2);
Â  Â  Â  itemDiv.append(nameSpan, priceSpan);
Â  Â  Â  itemsDiv.appendChild(itemDiv);
Â  Â  Â  subtotal += item.price * item.qty;
Â  Â  });
Â  Â  subtotalEl.textContent = "â‚¹" + subtotal.toFixed(2);
Â  Â  return subtotal;
Â  }

Â  function computeShipping(pin) {
Â  Â  if (!pin) return 0;
Â  Â  pin = pin.trim();
Â  Â  if (/^6/.test(pin)) return 50;
Â  Â  if (/^5/.test(pin)) return 70;
Â  Â  return 100;
Â  }

Â  function computeTotal(subtotal, shipping) {
Â  Â  return subtotal + shipping;
Â  }

Â  // ---------- Initialize ----------
Â  let subtotal = renderCart();
Â  let shipping = 0;
Â  shippingEl.textContent = "â‚¹" + shipping.toFixed(2);
Â  totalEl.textContent = "â‚¹" + computeTotal(subtotal, shipping).toFixed(2);

Â  pinInput.addEventListener("blur", () => {
Â  Â  const pin = pinInput.value;
Â  Â  shipping = computeShipping(pin);
Â  Â  shippingEl.textContent = "â‚¹" + shipping.toFixed(2);
Â  Â  totalEl.textContent = "â‚¹" + computeTotal(subtotal, shipping).toFixed(2);
Â  });

Â  // ---------- Pay Now Button ----------
Â  btnPay.addEventListener("click", async (e) => {
Â  Â  e.preventDefault();

Â  Â  if (!form.checkValidity()) {
Â  Â  Â  alert("Please fill all required details.");
Â  Â  Â  return;
Â  Â  }

Â  Â  const formData = {
Â  Â  Â  name: form.name.value,
Â  Â  Â  phone: form.phone.value,
Â  Â  Â  address: form.address.value,
Â  Â  Â  pin: form.pin.value,
Â  Â  Â  city: form.city.value,
Â  Â  Â  state: form.state.value
Â  Â  };

Â  Â  const order = {
Â  Â  Â  items: cart,
Â  Â  Â  subtotal: subtotal,
Â  Â  Â  shipping: shipping,
Â  Â  Â  total: computeTotal(subtotal, shipping),
Â  Â  Â  customer: formData
Â  Â  };

Â  Â  try {
Â  Â  Â  // Step 1: Create Razorpay Order
Â  Â  Â  // UPDATED: Using the API_BASE_URL variable
Â  Â  Â  const response = await fetch(`${API_BASE_URL}/create-order`, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify({ amount: order.total })
Â  Â  Â  });

Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  const errorText = await response.text();
Â  Â  Â  Â  console.error("Server error:", errorText);
Â  Â  Â  Â  alert("Failed to create Razorpay order.");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const data = await response.json();
Â  Â  Â  console.log("Razorpay Order Created:", data);

Â  Â  Â  // Step 2: Open Razorpay payment popup
Â  Â  Â  const options = {
Â  Â  Â  Â  key: "rzp_test_RWsNjENImz7rr4", // replace with your real key_id
Â  Â  Â  Â  amount: order.total * 100,
Â  Â  Â  Â  currency: "INR",
Â  Â  Â  Â  name: "Erumunai Organic Farm Foods",
Â  Â  Â  Â  description: "Order Payment",
Â  Â  Â  Â  order_id: data.id,
Â  Â  Â  Â  handler: async function (response) {
Â  Â  Â  Â  Â  // Step 3: Save order to Firebase after payment success
Â  Â  Â  Â  Â  const paymentData = {
Â  Â  Â  Â  Â  Â  ...order,
Â  Â  Â  Â  Â  Â  payment_id: response.razorpay_payment_id,
Â  Â  Â  Â  Â  Â  order_id: response.razorpay_order_id,
Â  Â  Â  Â  Â  Â  signature: response.razorpay_signature,
Â  Â  Â  Â  Â  Â  status: "Paid",
Â  Â  Â  Â  Â  Â  date: new Date().toISOString()
Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // UPDATED: Using the API_BASE_URL variable
Â  Â  Â  Â  Â  Â  const saveResponse = await fetch(`${API_BASE_URL}/save-order`, {
Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ orderData: paymentData })
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!saveResponse.ok) {
Â  Â  Â  Â  Â  Â  Â  const errorText = await saveResponse.text();
Â  Â  Â  Â  Â  Â  Â  console.error("Save Order Error:", errorText);
Â  Â  Â  Â  Â  Â  Â  alert("Payment succeeded but order not saved!");
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  alert("Payment Successful! Your order has been placed.");
Â  Â  Â  Â  Â  Â  localStorage.removeItem("cart");
Â  Â  Â  Â  Â  Â  window.location.href = "thankyou.html";
Â  Â  Â  Â  Â  } catch (saveErr) {
Â  Â  Â  Â  Â  Â  console.error("Error saving order:", saveErr);
Â  Â  Â  Â  Â  Â  alert("Error saving order details.");
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  prefill: {
Â  Â  Â  Â  Â  name: formData.name,
Â  Â  Â  Â  Â  contact: formData.phone
Â  Â  Â  Â  },
Â  Â  Â  Â  theme: { color: "#2f6f31" }
Â  Â  Â  };

Â  Â  Â  const rzp = new Razorpay(options);
Â  Â  Â  rzp.open();

Â  Â  } catch (err) {
Â  Â  Â  console.error("Payment initiation error:", err);
Â  Â  Â  alert("Something went wrong. Please try again.");
Â  Â  }
Â  });
</script>

</body>

</html>