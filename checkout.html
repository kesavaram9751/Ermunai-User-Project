<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Ermunai Organic Farm Foods | 100% Organic & Ready-to-Cook Products in India</title>
    <meta name="description"
        content="Buy 100% organic, natural, and chemical-free farm foods from Ermunai Organic Farm Foods. Explore our range of ready-to-cook and ready-to-eat organic products, delivered fresh across India.">
    <meta name="keywords"
        content="organic food India, Ermunai Organic, organic farm foods, ready to cook, organic groceries, natural farm produce">
    <meta name="author" content="Ermunai Organic Farm Foods">
    <meta name="robots" content="index, follow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* (CSS styles remain the same) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f9faf6; color: #333; padding: 20px; }
        .container { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        @media(max-width: 800px) { .container { grid-template-columns: 1fr; } }
        .form-section, .summary-section { background: white; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        .form-section h2, .summary-section h2 { margin-bottom: 20px; font-size: 24px; color: #2f6f31; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .form-group textarea { resize: vertical; }
        .summary-section .cart-item { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .summary-section .cart-item span { font-size: 16px; }
        .summary-section .totals { margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px; }
        .totals .line { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .totals .line.total { font-weight: bold; font-size: 18px; }
        .btn-pay { display: inline-block; padding: 12px 24px; background: #2f6f31; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 20px; width: 100%; }
        .btn-pay:hover { background: #244021; }
    </style>
</head>

<body>
    <h1>Checkout</h1>
    <div class="container">
        <div class="form-section">
            <h2>Your Details</h2>
            <form id="checkoutForm">
                <div class="form-group">
                    <label for="name">Full Name*</label>
                    <input type="text" id="name" name="name" required />
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number*</label>
                    <input type="tel" id="phone" name="phone" required />
                </div>

                <div class="form-group">
                    <label for="address">Address*</label>
                    <textarea id="address" name="address" rows="3" required></textarea>
                </div>

                <div class="form-group">
                    <label for="pin">Pin Code*</label>
                    <input type="text" id="pin" name="pin" required />
                </div>

                <div class="form-group">
                    <label for="city">City*</label>
                    <input type="text" id="city" name="city" required />
                </div>

                <div class="form-group">
                    <label for="state">State*</label>
                    <input type="text" id="state" name="state" required />
                </div>
            </form>
        </div>

        <div class="summary-section">
            <h2>Order Summary</h2>
            <div id="itemsList"></div>

            <div class="totals">
                <div class="line">
                    <span>Subtotal</span>
                    <span id="subtotalAmt">₹0</span>
                </div>
                <div class="line">
                    <span>Shipping</span>
                    <span id="shippingAmt">₹0</span>
                </div>
                <div class="line total">
                    <span>Total</span>
                    <span id="totalAmt">₹0</span>
                </div>
            </div>

            <button id="btnPay" class="btn-pay">Pay Now</button>
        </div>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script type="module">
        // -------------------------------------------------------------------------------------
        // Replace this with your backend URL
        const API_BASE_URL = "https://ermunai-user-project-production.up.railway.app";

        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbfdG2XU302FuZx0MapVTRmb3Qtaa-hA8",
            authDomain: "ermunai-e-commerce-project.firebaseapp.com",
            projectId: "ermunai-e-commerce-project",
            storageBucket: "ermunai-e-commerce-project.appspot.com",
            messagingSenderId: "365240050790",
            appId: "1:365240050790:web:2d4867d6ab4f93a661f9a7",
            measurementId: "G-CZJZ4HLCMR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Authentication state
        let currentUser = null;         // firebase.User object (trusted)
        let userContactEmail = null;    // for Razorpay prefill

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userContactEmail = user.email || null;
                console.log("Checkout user is logged in with UID:", user.uid);
            } else {
                // redirect to login
                alert("Please log in to complete your purchase.");
                window.location.href = "login.html";
            }
        });

        // ---------- Load cart from localStorage ----------
        let cart = JSON.parse(localStorage.getItem("cart") || "[]");

        const itemsDiv = document.getElementById("itemsList");
        const subtotalEl = document.getElementById("subtotalAmt");
        const shippingEl = document.getElementById("shippingAmt");
        const totalEl = document.getElementById("totalAmt");
        const btnPay = document.getElementById("btnPay");
        const pinInput = document.getElementById("pin");
        const form = document.getElementById("checkoutForm");

        function renderCart() {
            itemsDiv.innerHTML = "";
            let subtotal = 0;
            cart.forEach(item => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "cart-item";
                const nameSpan = document.createElement("span");
                nameSpan.textContent = item.name + " × " + (item.qty || 1);
                const priceSpan = document.createElement("span");
                priceSpan.textContent = "₹" + ((item.price || 0) * (item.qty || 1)).toFixed(2);
                itemDiv.append(nameSpan, priceSpan);
                itemsDiv.appendChild(itemDiv);
                subtotal += (item.price || 0) * (item.qty || 1);
            });
            subtotalEl.textContent = "₹" + subtotal.toFixed(2);
            return subtotal;
        }

        function computeShipping(pin) {
            if (!pin) return 0;
            pin = pin.trim();
            if (pin === "600001") return 0;
            if (/^6/.test(pin)) return 50;
            if (/^5/.test(pin)) return 70;
            return 100;
        }

        function computeTotal(subtotal, shipping) {
            return subtotal + shipping;
        }

        // Initialize
        let subtotal = renderCart();
        let shipping = 0;
        shippingEl.textContent = "₹" + shipping.toFixed(2);
        totalEl.textContent = "₹" + computeTotal(subtotal, shipping).toFixed(2);

        pinInput.addEventListener("blur", () => {
            const pin = pinInput.value;
            shipping = computeShipping(pin);
            shippingEl.textContent = "₹" + shipping.toFixed(2);
            totalEl.textContent = "₹" + computeTotal(subtotal, shipping).toFixed(2);
        });

        // Pay Now
        btnPay.addEventListener("click", async (e) => {
            e.preventDefault();

            if (!currentUser) {
                alert("Authentication is still loading. Please wait a moment and try again.");
                return;
            }

            if (!form.checkValidity()) {
                alert("Please fill all required details.");
                return;
            }

            if (cart.length === 0) {
                alert("Your cart is empty. Please add items to order.");
                return;
            }

            const formData = {
                name: form.name.value,
                phone: form.phone.value,
                address: form.address.value,
                pin: form.pin.value,
                city: form.city.value,
                state: form.state.value
            };

            const order = {
                items: cart,
                subtotal: subtotal,
                shipping: shipping,
                total: computeTotal(subtotal, shipping),
                customer: formData
            };

            try {
                // 1) Create order on server (server will create Razorpay order)
                const createResp = await fetch(`${API_BASE_URL}/create-order`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ amount: order.total })
                });

                if (!createResp.ok) {
                    const errorText = await createResp.text();
                    console.error("Server error (create-order):", errorText);
                    alert("Failed to create payment order. Try again later.");
                    return;
                }

                const razorpayOrder = await createResp.json();
                console.log("Razorpay Order Created (server):", razorpayOrder);

                // 2) Open Razorpay checkout (use server-provided order id)
                const options = {
                    key: "rzp_live_RaPexiedmItQ5c", // replace with your public key_id
                    amount: Math.round(order.total * 100), // amount in paise
                    currency: "INR",
                    name: "Ermunai Organic Farm Foods",
                    description: "Order Payment",
                    order_id: razorpayOrder.id, // important: server-created order id
                    handler: async function (response) {
                        // response should contain razorpay_payment_id, razorpay_order_id, razorpay_signature
                        console.log("Razorpay handler response:", response);

                        // Build payload to send to server. DO NOT send client-supplied uid.
                        const paymentData = {
                            ...order,
                            payment_id: response.razorpay_payment_id || null,
                            order_id: response.razorpay_order_id || razorpayOrder.id || null,
                            signature: response.razorpay_signature || null,
                            status: "Paid",
                            date: new Date().toISOString()
                        };

                        try {
                            // Get fresh idToken from firebase user and send in Authorization header
                            const idToken = await currentUser.getIdToken(true);

                            const saveResponse = await fetch(`${API_BASE_URL}/save-order`, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": "Bearer " + idToken
                                },
                                body: JSON.stringify({ orderData: paymentData })
                            });

                            if (!saveResponse.ok) {
                                const errorText = await saveResponse.text();
                                console.error("Save Order Error:", errorText);
                                alert("Payment succeeded but failed to save order. Contact support.");
                                return;
                            }

                            alert("Payment Successful! Your order has been placed.");
                            localStorage.removeItem("cart");
                            window.location.href = "thankyou.html";
                        } catch (saveErr) {
                            console.error("Error saving order (network):", saveErr);
                            alert("Payment succeeded but error saving order. Contact support.");
                        }
                    },
                    prefill: {
                        name: formData.name,
                        contact: formData.phone,
                        email: userContactEmail
                    },
                    theme: { color: "#2f6f31" }
                };

                const rzp = new Razorpay(options);
                rzp.open();

            } catch (err) {
                console.error("Payment initiation error:", err);
                alert("Something went wrong. Please try again.");
            }
        });
    </script>
</body>
</html>
